(g=>{let i={position:"bottom-right",theme:"light",language:"en",customStyles:{},debug:!1};class t{constructor(e){this.config={...i,...e},this.clientId=this.config.clientId,this.sessionId=null,this.isActive=!1,this.isListening=!1,this.audioContext=null,this.mediaStream=null,this.peerConnection=null,this.dataChannel=null,this.analyser=null,this.volumeInterval=null,this.currentVolume=0,this.ui=null,this.mode="idle",this.sessionValidationInProgress=!1,this.meetingUrl=this.config.meetingUrl,this.toolHandlers={},this._startSessionInProgress=!1,this.debug=this.config.debug||!1,this.lastLoggedTexts={},this.logDeduplicationWindow=2e3;let t=!(this.logger={log:(e,...t)=>{console.log(e,...t)},debug:(e,...t)=>{this.debug&&console.log("[DEBUG] "+e,...t)},error:(e,...t)=>{console.error(e,...t)},warn:(e,...t)=>{console.warn(e,...t)},logError:(e,i,o={})=>{if(console.error(e,i),this.sessionId){let t=e||"";if(i&&i.stack)t+="\nStacktrace: "+i.stack;else if(i&&i.message)t+="\nError: "+i.message;else if(i)try{t+="\nError: "+JSON.stringify(i)}catch(e){t+="\nError: "+String(i)}if(0<Object.keys(o).length)try{t+="\nContext: "+JSON.stringify(o)}catch(e){t+="\nContext: Unable to stringify context"}this._logTextToAPI("error",t,{source:"client_error",...o})}}});if(this.clientId||(this.logger.logError("Voice AI SDK: Client ID is required. Please provide a valid clientId in the configuration."),t=!0),this.config.serverUrl||(this.logger.logError("Voice AI SDK: Server URL is required. Please provide a valid serverUrl in the configuration.",null,{example:"https://voice-ai-sandy.vercel.app"}),this.logger.logError('Example: serverUrl: "https://voice-ai-sandy.vercel.app"'),t=!0),this.meetingUrl||(this.logger.logError("Voice AI SDK: Meeting URL is required. Please provide a valid meetingUrl in the configuration.",null,{example:"https://calendly.com/your-company/meeting"}),this.logger.logError('Example: meetingUrl: "https://calendly.com/your-company/meeting"'),t=!0),this.config.serverUrl)try{new URL(this.config.serverUrl)}catch(e){this.logger.logError(`Voice AI SDK: Invalid Server URL "${this.config.serverUrl}". Please provide a valid URL.`,e),t=!0}if(this.meetingUrl)try{new URL(this.meetingUrl)}catch(e){this.logger.logError(`Voice AI SDK: Invalid Meeting URL "${this.meetingUrl}". Please provide a valid URL.`,e),t=!0}console.log("Voice AI SDK: Current domain:",g.location.hostname),console.log("Voice AI SDK: Server URL:",this.config.serverUrl),t?this.logger.logError("Voice AI SDK: Initialization failed due to configuration errors."):this._init()}async _init(){try{this.sessionId=this.config.sessionId||`sdk_${Date.now()}_`+Math.random().toString(36).substring(2,9),this.logger.debug("Session ID:",this.sessionId),await this._loadSession(),await this._validateClient(),await this._initSession(),this._createUI(),this._registerEventListeners(),this._registerToolHandlers(),"function"==typeof this.config.onReady&&this.config.onReady()}catch(e){this.logger.logError("Voice AI SDK: Initialization error",e),"function"==typeof this.config.onError&&this.config.onError(e)}}_registerToolHandlers(){this.toolHandlers.show_booking_popup=e=>this._showBookingPopup(e.message),console.log("Voice AI SDK: Registered tool handlers",Object.keys(this.toolHandlers))}_showBookingPopup(e){console.log("Voice AI SDK: Showing booking popup",e);let t=document.createElement("div");t.className="voice-ai-booking-popup",t.style.position="fixed",t.style.bottom="100px",t.style.right="20px",t.style.width="300px",t.style.padding="20px",t.style.backgroundColor="#ffffff",t.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",t.style.borderRadius="8px",t.style.zIndex="10000",t.style.fontFamily="Arial, sans-serif",t.style.display="flex",t.style.flexDirection="column",t.style.gap="15px";var i=document.createElement("div");i.textContent=e||"Please book a meeting with our team",i.style.fontSize="14px",i.style.lineHeight="1.5",i.style.color="#333333";let o=document.createElement("a");o.href=this.meetingUrl,o.target="_blank",o.textContent="Book a Meeting",o.style.display="inline-block",o.style.padding="10px 16px",o.style.backgroundColor="#4a90e2",o.style.color="#ffffff",o.style.textDecoration="none",o.style.borderRadius="4px",o.style.fontWeight="bold",o.style.textAlign="center",o.style.cursor="pointer",o.style.transition="background-color 0.2s",o.onmouseover=()=>{o.style.backgroundColor="#3a80d2"},o.onmouseout=()=>{o.style.backgroundColor="#4a90e2"};e=document.createElement("button");return e.textContent="Ã—",e.style.position="absolute",e.style.top="10px",e.style.right="10px",e.style.background="none",e.style.border="none",e.style.fontSize="20px",e.style.cursor="pointer",e.style.color="#999999",e.style.padding="0",e.style.lineHeight="1",e.onclick=()=>{document.body.removeChild(t)},t.appendChild(e),t.appendChild(i),t.appendChild(o),document.body.appendChild(t),setTimeout(()=>{document.body.contains(t)&&document.body.removeChild(t)},3e4),setTimeout(()=>{this.isActive&&(console.log("Voice AI SDK: Auto-stopping session after showing booking popup"),this.stopSession())},1e4),{success:!0,message:"Booking popup displayed"}}async _loadSession(){try{var e,t=localStorage.getItem("voice_ai_session");t?(e=JSON.parse(t)).clientId===this.clientId?(console.log("Voice AI SDK: Found saved session",e.sessionId),await this._validateSession(e.sessionId)?(this.sessionId=e.sessionId,console.log("Voice AI SDK: Session validated successfully",this.sessionId)):(console.log("Voice AI SDK: Saved session is invalid, will create a new one"),localStorage.removeItem("voice_ai_session"),this.sessionId=null)):(console.log("Voice AI SDK: Saved session belongs to different client, will create a new one"),localStorage.removeItem("voice_ai_session")):console.log("Voice AI SDK: No saved session found")}catch(e){console.error("Voice AI SDK: Failed to load session",e),localStorage.removeItem("voice_ai_session"),this.sessionId=null}}async _validateSession(e){if(this.sessionValidationInProgress)return console.log("Voice AI SDK: Session validation already in progress"),!1;this.sessionValidationInProgress=!0;try{console.log("Voice AI SDK: Validating session",e);try{if((await fetch(this.config.serverUrl+"/api/v1/sessions?sessionId="+e,{method:"GET"})).ok)return this.sessionValidationInProgress=!1,console.log("Voice AI SDK: Session validated successfully"),!0}catch(e){console.error("Voice AI SDK: Error during session validation",e)}return console.log("Voice AI SDK: Session validation failed"),this.sessionValidationInProgress=!1}catch(e){return console.error("Voice AI SDK: Session validation failed",e),this.sessionValidationInProgress=!1}}_saveSession(){try{localStorage.setItem("voice_ai_session",JSON.stringify({clientId:this.clientId,sessionId:this.sessionId})),console.log("Voice AI SDK: Session saved to localStorage",this.sessionId)}catch(e){console.error("Voice AI SDK: Failed to save session",e)}}async _validateClient(){try{console.log(`Voice AI SDK: Validating client "${this.clientId}" with server at "${this.config.serverUrl}"`),console.log("Voice AI SDK: Current page URL: "+g.location.href);var e=this.config.serverUrl+"/api/v1/auth/validate",t=(console.log("Voice AI SDK: Validation endpoint: "+e),await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:this.clientId})}));if(!t.ok){var i=t.status;let e;try{e=await t.json()}catch(e){throw new Error(`Server returned ${i} status code. Check if your domain is authorized for this client ID.`)}throw 403===i?(this.logger.logError(`Voice AI SDK: Domain "${g.location.hostname}" is not authorized for client "${this.clientId}".`,null,{clientId:this.clientId,domain:g.location.hostname,statusCode:i}),this.logger.logError("Voice AI SDK: Make sure your domain is added to the CLIENT_"+this.clientId+"_DOMAINS environment variable on the server."),new Error(e.error||"Domain not authorized. Status: "+i)):new Error(e.error||"Client validation failed. Status: "+i)}var o=await t.json();if(!o.valid)throw new Error(o.error||"Client validation failed: Server returned invalid status");console.log("Voice AI SDK: Client validated successfully")}catch(e){throw this.logger.logError("Voice AI SDK: Client validation failed",e,{clientId:this.clientId,serverUrl:this.config.serverUrl,domain:g.location.hostname}),(e.message.includes("NetworkError")||e.message.includes("Failed to fetch"))&&(this.logger.logError("Voice AI SDK: Network error occurred. This might be due to CORS restrictions.",e),this.logger.logError(`Voice AI SDK: Make sure your domain "${g.location.hostname}" is added to the CLIENT_${this.clientId}_DOMAINS environment variable on the server.`),this.logger.logError(`Voice AI SDK: Also check that the serverUrl "${this.config.serverUrl}" is correct and accessible.`)),e}}async _initSession(){try{if(this.sessionId)this.logger.log("Using existing session",this.sessionId);else{this.logger.log("Creating new session");try{var e=await fetch(this.config.serverUrl+"/api/v1/sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:this.clientId})}),t=await e.json();if(!e.ok)throw new Error(t.error||"Failed to create session");this.sessionId=t.sessionId,this.logger.log("New session created",this.sessionId),this._saveSession(),this.logger.debug("Waiting for session to be fully registered..."),await new Promise(e=>setTimeout(e,500))}catch(e){throw e}}}catch(e){throw this.logger.error("Session initialization failed",e),e}}_createUI(){var e=document.createElement("div");switch(e.className="voice-ai-container",e.style.position="fixed",this.config.position){case"bottom-right":e.style.bottom="20px",e.style.right="20px";break;case"bottom-left":e.style.bottom="20px",e.style.left="20px";break;case"top-right":e.style.top="20px",e.style.right="20px";break;case"top-left":e.style.top="20px",e.style.left="20px";break;default:e.style.bottom="20px",e.style.right="20px"}var t=document.createElement("div"),i=(t.className="voice-ai-button",t.style.width="64px",t.style.height="64px",t.style.borderRadius="50%",t.style.backgroundColor=this.config.customStyles.buttonColor||"#3a86ff",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.cursor="pointer",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)",t.style.transition="all 0.3s ease",document.createElement("div")),o=(i.className="voice-ai-animation",i.style.width="100%",i.style.height="100%",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",document.createElement("div")),s=(o.className="voice-ai-idle-animation",o.style.width="32px",o.style.height="32px",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.animation="voice-ai-pulse 2s infinite",document.createElement("img")),s=(s.src=`${this.config.serverUrl||""}/microphone.svg`,s.alt="Microphone",s.style.width="24px",s.style.height="24px",o.appendChild(s),i.appendChild(o),t.appendChild(i),e.appendChild(t),document.createElement("style"));s.textContent=`
          @keyframes voice-ai-pulse {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.5; }
          }
          
          @keyframes voice-ai-thinking {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
          }
          
          @keyframes voice-ai-volume {
            0% { height: 10px; }
            50% { height: 30px; }
            100% { height: 10px; }
          }
        `,document.head.appendChild(s),document.body.appendChild(e),this.ui={container:e,button:t,animationContainer:i,idleAnimation:o},t.addEventListener("click",()=>{this.toggleSession()})}_registerEventListeners(){g.addEventListener("beforeunload",()=>{this.isActive&&this.stopSession()})}_updateUI(e,s=0){if(this.uiMode=e,this.ui){var t=this.ui.button,i=this.ui.animationContainer,o=this.ui.container.querySelector(".voice-ai-status");this.ui.idleAnimation?.querySelector("img");if(t&&i){for(;i.firstChild;)i.removeChild(i.firstChild);switch(e){case"loading":var n=document.createElement("div");n.className="voice-ai-loading-animation",i.appendChild(n),o&&(o.textContent="Connecting...");break;case"active":var r=document.createElement("div");r.className="voice-ai-volume-container";for(let e=0;e<4;e++){var a=document.createElement("div");a.className="voice-ai-volume-bar",a.style.width="4px",a.style.backgroundColor="#ffffff",a.style.borderRadius="2px",a.style.height="10px",a.style.transition="height 0.3s ease-in-out",r.appendChild(a)}i.appendChild(r),this.ui.volumeBars=Array.from(r.querySelectorAll(".voice-ai-volume-bar")),o&&(o.textContent="Listening...");break;case"thinking":n=document.createElement("div");n.className="voice-ai-thinking-animation",i.appendChild(n),o&&(o.textContent="Thinking...");break;case"responding":n=document.createElement("div");n.className="voice-ai-responding-animation",i.appendChild(n),o&&(o.textContent="Responding...");break;case"error":var n=document.createElement("div"),l=(n.className="voice-ai-error-animation",n.style.backgroundColor="#ff3b30",document.createElement("div"));l.className="voice-ai-error-pulse",n.appendChild(l),i.appendChild(n),o&&(o.textContent="Error"),setTimeout(()=>{"error"===this.uiMode&&(this._updateUI("idle"),this.isActive)&&(this._cleanupWebRTC(),this.isActive=!1,this.isListening=!1,setTimeout(()=>{this.startSession()},1e3))},5e3);break;case"volume":if(this.ui.volumeBars&&0<this.ui.volumeBars.length&&i.querySelector(".voice-ai-volume-container"))this.ui.volumeBars.forEach((e,t)=>{var i=.9+.2*Math.random(),i=Math.max(10,Math.min(30,400*s*i)),o=g.getComputedStyle(e),o=parseInt(o.height,10);e.style.height=.7*o+.3*i+"px"});else{var c=document.createElement("div");c.className="voice-ai-volume-container",this.ui.volumeBars=[];for(let e=0;e<4;e++){var h=document.createElement("div"),d=(h.className="voice-ai-volume-bar",h.style.width="4px",h.style.backgroundColor="#ffffff",h.style.borderRadius="2px",h.style.transition="height 0.3s ease-in-out",.9+.2*Math.random()),d=Math.max(10,Math.min(30,400*s*d));h.style.height=d+"px",c.appendChild(h),this.ui.volumeBars.push(h)}i.appendChild(c)}o&&(o.textContent="Listening...");break;default:l=document.createElement("div"),n=(l.className="voice-ai-idle-animation",document.createElement("img"));n.src=`${this.config.serverUrl||""}/microphone.svg`,n.alt="Microphone",n.style.width="24px",n.style.height="24px",l.appendChild(n),i.appendChild(l),this.ui.idleAnimation=l,o&&(o.textContent="Click to talk")}}}}async _configureSession(){try{this.logger.log("Configuring session with ID:",this.sessionId);var e=await this.peerConnection.createOffer(),t=(await this.peerConnection.setLocalDescription(e),this.logger.log("Sending WebRTC offer to server"),console.log("Voice AI SDK: Sending WebRTC offer to server"),await fetch(this.config.serverUrl+"/api/v1/voice/process",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:this.clientId,sessionId:this.sessionId,offer:this.peerConnection.localDescription,voice:this.config.voice||"alloy"})})),i=await t.json();if(t.ok)return await this.peerConnection.setRemoteDescription(i.answer),this.logger.log("WebRTC session configured successfully",{sessionId:this.sessionId}),console.log("Voice AI SDK: WebRTC session configured successfully"),!0;var o=i.error||"Failed to configure session";if(404===t.status&&i.newSessionId)return this.logger.log("Server provided new session ID:",i.newSessionId),this.sessionId=i.newSessionId,this.logger.debug("Waiting for session to be fully registered..."),new Promise(e=>{setTimeout(async()=>{this.logger.debug("Retrying with new session ID"),e(await this._configureSession())},1e3)});if(404===t.status&&o.includes("Session not found"))return this.logger.log("Session not found, creating a new one"),this.sessionId=null,localStorage.removeItem("voice_ai_session"),await this._initSession(),this.logger.debug("Waiting for session to be fully registered..."),new Promise(e=>{setTimeout(async()=>{this.logger.debug("Retrying with new session ID"),e(await this._configureSession())},1e3)});throw new Error(o)}catch(e){throw this.logger.error("Failed to configure session",e),console.error("Voice AI SDK: Failed to configure session:",e),e}}_onDataChannelOpen(){this.logger.log("Data channel opened"),setTimeout(()=>{this._configureDataChannel(),this._updateUI("responding")},500)}_configureDataChannel(){this.dataChannel?"open"!==this.dataChannel.readyState?(this.logger.error("Data channel not open, cannot configure. State:",this.dataChannel.readyState),this._updateUI("error")):(this.logger.log("Configuring data channel"),console.log("Voice AI SDK: Configuring data channel - optimized, no session.update"),(async()=>{try{var e,t,i=()=>!(!this.dataChannel||"open"!==this.dataChannel.readyState)||(this.logger.error("Data channel closed while configuring"),this._updateUI("error"),!1);i()&&(console.log("Voice AI SDK: Sending initial user message and response request"),e={type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:"Begin the conversation"}]}},this._logTextToAPI("user","Begin the conversation"),await this.dataChannel.send(JSON.stringify(e)),console.log("Voice AI SDK: Initial user message sent"),i()&&(t={type:"response.create"},await this.dataChannel.send(JSON.stringify(t)),console.log("Voice AI SDK: Response creation request sent")),console.log("Voice AI SDK: Data channel configuration completed"))}catch(e){this.logger.error("Error sending messages:",e),console.error("Voice AI SDK: Error configuring data channel:",e),this._updateUI("error"),"function"==typeof this.config.onError&&this.config.onError(new Error("Error configuring data channel: "+e.message))}})()):(this.logger.error("Data channel not available, cannot configure"),this._updateUI("error"))}_onDataChannelMessage(t){try{let r=JSON.parse(t.data);switch(this.logger.debug("Received message",r),r.type){case"thinking":this._updateUI("thinking");break;case"responding":this._updateUI("responding");break;case"conversation.item.input_audio_transcription.completed":var e;r.transcript&&(e="string"==typeof r.transcript?r.transcript:r.transcript.text||"")&&this._logTextToAPI("user",e,{isTranscription:!0,source:"audio_transcription",messageType:r.type,itemId:r.item_id});break;case"response.done":r.response&&r.response.output&&r.response.output.forEach((i,o)=>{if(i.content){let e="",t=!1;var s,n=i.role||"assistant";Array.isArray(i.content)?(s=i.content.find(e=>"audio"===e.type))&&s.transcript?(e=s.transcript,t=!0):e=i.content.filter(e=>"text"===e.type||"audio"===e.type).map(e=>e.text||e.transcript).filter(Boolean).join(" "):"string"==typeof i.content&&(e=i.content),e&&this._logTextToAPI(n,e,{isTranscription:t,source:t?"audio_transcription":"response_output",messageType:r.type,itemId:i.id,responseId:r.response.id,outputIndex:o,isFinalResponse:!0})}});break;case"function_call":if(this.logger.log("Function call received",r.function_call),r.function_call&&r.function_call.name){var i,o,s=r.function_call.name,n=r.function_call.arguments||{},a=r.function_call.id||"unknown";if(this.toolHandlers[s])try{var l,c=this.toolHandlers[s](n);this.dataChannel&&"open"===this.dataChannel.readyState&&(l={type:"function_call_response",function_call_id:a,result:c},this.dataChannel.send(JSON.stringify(l)))}catch(e){this.logger.logError("Voice AI SDK: Error executing function "+s,e,{functionName:s,functionArgs:n,functionCallId:a}),this.dataChannel&&"open"===this.dataChannel.readyState&&(o={type:"function_call_response",function_call_id:a,error:e.message||"Error executing function"},this.dataChannel.send(JSON.stringify(o))),this._updateUI("error")}else this.logger.logError(`Voice AI SDK: Function ${s} not found`,null,{functionName:s,availableFunctions:Object.keys(this.toolHandlers)}),this.dataChannel&&"open"===this.dataChannel.readyState&&(i={type:"function_call_response",function_call_id:a,error:`Function ${s} not found`},this.dataChannel.send(JSON.stringify(i))),this._updateUI("error")}else this.logger.logError("Voice AI SDK: Invalid function call format",r,{messageType:r.type}),this._updateUI("error");break;case"response.function_call_arguments.done":if(console.log("Voice AI SDK: Function call received from OpenAI",r),r.name){var h=r.name;let t={};var d,g,u=r.call_id||"unknown";try{r.arguments&&(t=JSON.parse(r.arguments))}catch(e){this.logger.logError("Voice AI SDK: Error parsing function arguments",e,{rawArguments:r.arguments,functionName:h})}if(this.toolHandlers[h])try{this.lastFunctionCalled=h;var p,f=this.toolHandlers[h](t);this.dataChannel&&"open"===this.dataChannel.readyState&&(p={type:"conversation.item.create",item:{type:"function_call_output",call_id:u,output:JSON.stringify(f)}},this.dataChannel.send(JSON.stringify(p)))}catch(e){this.logger.logError("Voice AI SDK: Error executing function "+h,e,{functionName:h,functionArgs:t,functionCallId:u}),this.dataChannel&&"open"===this.dataChannel.readyState&&(g={type:"conversation.item.create",item:{type:"function_call_output",call_id:u,output:JSON.stringify({error:e.message||"Error executing function"})}},this.dataChannel.send(JSON.stringify(g))),this._updateUI("error")}else this.logger.logError(`Voice AI SDK: Function ${h} not found`,null,{functionName:h,availableFunctions:Object.keys(this.toolHandlers)}),this.dataChannel&&"open"===this.dataChannel.readyState&&(d={type:"conversation.item.create",item:{type:"function_call_output",call_id:u,output:JSON.stringify({error:`Function ${h} not found`})}},this.dataChannel.send(JSON.stringify(d))),this._updateUI("error")}else this.logger.logError("Voice AI SDK: Invalid function call format from OpenAI",r,{messageType:r.type}),this._updateUI("error");break;case"error":this.logger.logError("Voice AI SDK: Error from server",r.error,{messageType:r.type,errorDetails:r}),"function"==typeof this.config.onError&&this.config.onError(new Error(r.error)),this._updateUI("error");break;case"input_audio_buffer.speech_started":this._updateUI("volume",this.currentVolume||.1);break;case"input_audio_buffer.speech_ended":case"output_audio_buffer.started":case"output_audio_buffer.ended":this._updateUI("responding")}}catch(e){this.logger.logError("Voice AI SDK: Error parsing message",e,{rawMessage:t.data?"string"==typeof t.data?t.data.substring(0,200)+"...":"non-string data":"empty data"})}}_onDataChannelClose(){this.logger.log("Data channel closed"),this.isListening=!1,this._updateUI("idle"),this.isActive&&(this.isActive=!1,"function"==typeof this.config.onEnd)&&this.config.onEnd()}_onDataChannelError(e){this.logger.error("Data channel error",e),this._updateUI("error"),"function"==typeof this.config.onError&&this.config.onError(new Error("Data channel error: "+(e.message||"Unknown error"))),this._cleanupWebRTC(),this.isActive=!1,this.isListening=!1}_onIceCandidate(e){e.candidate&&this.logger.debug("New ICE candidate",e.candidate)}_onConnectionStateChange(){if(this.peerConnection)switch(this.logger.debug("Connection state changed to",this.peerConnection.connectionState),this.peerConnection.connectionState){case"connected":this.logger.log("WebRTC connection established");break;case"disconnected":this.logger.log("WebRTC connection disconnected, attempting to recover"),this._updateUI("error"),"function"==typeof this.config.onError&&this.config.onError(new Error("WebRTC connection disconnected, attempting to recover")),setTimeout(()=>{!this.peerConnection||"disconnected"!==this.peerConnection.connectionState&&"failed"!==this.peerConnection.connectionState||(this.logger.log("WebRTC connection failed to recover, cleaning up"),this._cleanupWebRTC(),this.isActive=!1,this.isListening=!1,"function"==typeof this.config.onEnd&&this.config.onEnd())},5e3);break;case"failed":this.logger.error("WebRTC connection failed"),this._updateUI("error"),"function"==typeof this.config.onError&&this.config.onError(new Error("WebRTC connection failed")),this._cleanupWebRTC(),this.isActive=!1,this.isListening=!1,"function"==typeof this.config.onEnd&&this.config.onEnd();break;case"closed":this.logger.log("WebRTC connection closed"),this._updateUI("inactive")}}_cleanupWebRTC(){if(this.logger.log("Cleaning up WebRTC resources"),this.dataChannel){try{this.dataChannel.close()}catch(e){this.logger.error("Error closing data channel",e)}this.dataChannel=null}if(this.peerConnection){try{this.peerConnection.onicecandidate=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.ontrack=null,this.peerConnection.close()}catch(e){this.logger.error("Error closing peer connection",e)}this.peerConnection=null}if(this.stream){try{this.stream.getTracks().forEach(e=>{e.stop()})}catch(e){this.logger.error("Error stopping media stream",e)}this.stream=null}if(this.audioElement){try{this.audioElement.srcObject=null,this.audioElement.remove()}catch(e){this.logger.error("Error cleaning up audio element",e)}this.audioElement=null}this.isActive=!1,this.isListening=!1}async startSession(){if(!this.isActive&&!this._startSessionInProgress){this._startSessionInProgress=!0;try{this._updateUI("loading"),this.sessionId||(this.sessionId=`sdk_${Date.now()}_`+Math.random().toString(36).substring(2,9),this.logger.debug("Generated new session ID:",this.sessionId)),await this._initWebRTC()?(await this._configureSession(),this.isActive=!0,this.isListening=!0,"function"==typeof this.config.onStart&&this.config.onStart()):(this._updateUI("error"),this._startSessionInProgress=!1)}catch(e){this.logger.logError("Failed to start session",e,{sessionId:this.sessionId,clientId:this.clientId}),this._cleanupWebRTC(),this._updateUI("error"),"function"==typeof this.config.onError&&this.config.onError(e)}finally{this._startSessionInProgress=!1}}}stopSession(){this.logger.log("Stopping session"),this.isActive||this._startSessionInProgress?(this.volumeInterval&&(clearInterval(this.volumeInterval),this.volumeInterval=null),this.volumeTimeout&&(clearTimeout(this.volumeTimeout),this.volumeTimeout=null),this.audioContext&&(this.audioContext.close().catch(console.error),this.audioContext=null,this.analyser=null),this.stream&&(this.stream.getTracks().forEach(e=>{e.stop()}),this.stream=null),this._cleanupWebRTC(),this.isActive=!1,this.isListening=!1,this.currentVolume=0,this._startSessionInProgress=!1,this._updateUI("idle"),"function"==typeof this.config.onEnd&&this.config.onEnd()):this.logger.debug("Session already stopped")}toggleSession(){this.isActive?this.stopSession():(this._updateUI("loading"),this.startSession())}async _initWebRTC(){try{this.logger.log("Initializing WebRTC"),this._cleanupWebRTC(),this.peerConnection=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),this.peerConnection.onicecandidate=this._onIceCandidate.bind(this),this.peerConnection.onconnectionstatechange=this._onConnectionStateChange.bind(this);try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(e){return this.logger.error("Error accessing microphone",e),"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?(this.logger.error("Microphone permission denied"),alert("Voice AI requires microphone access. Please allow microphone access and try again.")):alert("Error accessing microphone. Please check your device settings and try again."),!1}this._setupAudioVisualization(this.stream),this.stream.getAudioTracks().forEach(e=>{this.peerConnection.addTrack(e,this.stream)}),this.audioElement=document.createElement("audio"),this.audioElement.autoplay=!0,this.peerConnection.ontrack=e=>{this.logger.debug("Received audio track"),this.audioElement.srcObject=e.streams[0]},this.dataChannel=this.peerConnection.createDataChannel("response"),this.dataChannel.onopen=this._onDataChannelOpen.bind(this),this.dataChannel.onmessage=this._onDataChannelMessage.bind(this),this.dataChannel.onclose=this._onDataChannelClose.bind(this),this.dataChannel.onerror=this._onDataChannelError.bind(this);var e=await this.peerConnection.createOffer();return await this.peerConnection.setLocalDescription(e),this.logger.debug("Created offer"),!0}catch(e){return this.logger.error("Error initializing WebRTC",e),this._updateUI("error"),!1}}_setupAudioVisualization(e){try{var i=new(g.AudioContext||g.webkitAudioContext),o=i.createMediaStreamSource(e);let r=i.createAnalyser();r.fftSize=256,o.connect(r);var s=r.frequencyBinCount;let a=new Uint8Array(s),t=(this.volumeHistory=Array(5).fill(.1),()=>{r.getByteTimeDomainData(a);let t=0;for(let e=0;e<a.length;e++){var i=(a[e]-128)/128;t+=i*i}var e=Math.sqrt(t/a.length);this.volumeHistory.push(e),this.volumeHistory.shift();let o=0,s=0;for(let e=0;e<this.volumeHistory.length;e++){var n=e+1;o+=this.volumeHistory[e]*n,s+=n}return Math.max(.05,o/s)});this.volumeInterval=setInterval(()=>{var e;this.isActive&&this.isListening&&"volume"===this.uiMode&&(e=t(),this._updateUI("volume",e)),this.currentVolume=t()},100),this.audioContext=i,this.analyser=r}catch(e){console.error("Voice AI SDK: Error setting up audio visualization",e)}}_startVolumeDetection(){if(this.analyser){let n=this.analyser.frequencyBinCount,r=new Uint8Array(n);this.volumeHistory||(this.volumeHistory=Array(5).fill(0)),this.volumeInterval=setInterval(()=>{if(this.analyser){this.analyser.getByteFrequencyData(r);let t=0;for(let e=0;e<n;e++)t+=r[e];var e=t/n/255;this.volumeHistory.push(e),this.volumeHistory.shift();let i=0,o=0;for(let e=0;e<this.volumeHistory.length;e++){var s=e+1;i+=this.volumeHistory[e]*s,o+=s}this.currentVolume=i/o,this.isListening&&"volume"===this.uiMode&&this._updateUI("volume",this.currentVolume)}},100)}}_stopVolumeDetection(){this.volumeInterval&&(clearInterval(this.volumeInterval),this.volumeInterval=null)}_logTextToAPI(t,s,n={}){try{if(this.sessionId){let i="user"===t||"assistant"===t||"error"===t?t:"assistant",e="";if("string"==typeof s)e=s;else if(s&&"object"==typeof s)if(s.text)e=s.text;else if(s.transcript)e=s.transcript,n.isTranscription=!0,n.source="audio_transcription";else if(s.content)e="string"==typeof s.content?s.content:JSON.stringify(s.content);else try{e=JSON.stringify(s)}catch(e){return void this.logger.logError("Voice AI SDK: Cannot convert object to string for logging",e,{textObject:typeof s,textType:t})}else{if(null==s)return void this.logger.logError("Voice AI SDK: Cannot log null or undefined text",null,{textType:t,options:n});e=String(s)}let o=e.trim();if(o){let t=n.isTranscription||o.includes("\n")&&"user"===i;var r={clientId:this.config.clientId,sessionId:this.sessionId,type:i,text:o};t&&(r.isTranscription=!0),n.source&&(r.source=n.source),fetch(this.config.serverUrl+"/api/v1/voice/text-log",{method:"POST",headers:{"Content-Type":"application/json",Referer:g.location.href},body:JSON.stringify(r)}).then(t=>t.ok?t.json():t.json().then(e=>{throw this.logger.logError("Voice AI SDK: Text logging failed:",e,{status:t.status,sessionId:this.sessionId,textType:i}),new Error("Failed to log text: "+(e.error||t.status))})).then(e=>{this.logger.debug("Text logged successfully to API:",e)}).catch(e=>{this.logger.logError("Voice AI SDK: Error logging text to API:",e,{sessionId:this.sessionId,clientId:this.clientId,textType:i,textLength:o.length,isTranscription:t,source:n.source}),console.error("Voice AI SDK: Failed text log details:",{type:i,sessionId:this.sessionId,textLength:o.length,textPreview:o.substring(0,50)+(50<o.length?"...":""),isTranscription:t})})}}else this.logger.logError("Voice AI SDK: Cannot log text: No session ID available",null,{textType:t,options:n})}catch(e){this.logger.logError("Voice AI SDK: Error preparing text log request:",e,{sessionId:this.sessionId,clientId:this.clientId,textType:typeof s});try{console.error("Voice AI SDK: Text log error details:",{type:normalizedType,sessionId:this.sessionId,textType:typeof s,error:e.message})}catch(e){console.error("Voice AI SDK: Failed to log error details")}}}_sendUserText(e){if(this.dataChannel&&"open"===this.dataChannel.readyState)try{var t={type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:e}]}},i=(this.dataChannel.send(JSON.stringify(t)),this._logTextToAPI("user",e),"function"==typeof this.config.onMessage&&this.config.onMessage({role:"user",content:e}),{type:"response.create"});this.dataChannel.send(JSON.stringify(i))}catch(e){this.logger.error("Error sending user text:",e)}else this.logger.error("Cannot send text: Data channel not open")}async _initialize(e){if(this.logger=new Logger({debug:e.debug||!1,logger:e.logger||console}),this.logger.log("Initializing Voice AI SDK"),this.config={...this.defaultConfig,...e},this.clientId=this.config.clientId||this._generateClientId(),this.logger.log("Client ID:",this.clientId),this.sessionId=this.config.sessionId||null,await this._loadSession(),!await this._validateClient())throw new Error("Client validation failed");this.config.headless||this._createUI(),this._registerEventListeners(),this._registerToolHandlers(),this.logger.log("Voice AI SDK initialized successfully")}}g.VoiceAI={init:e=>new t(e)}})(window);