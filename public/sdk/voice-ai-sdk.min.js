(u=>{let i={position:"bottom-right",theme:"light",language:"en",customStyles:{},debug:!1};class t{constructor(e){this.config={...i,...e},this.clientId=this.config.clientId,this.sessionId=null,this.isActive=!1,this.isListening=!1,this.audioContext=null,this.mediaStream=null,this.peerConnection=null,this.dataChannel=null,this.analyser=null,this.volumeInterval=null,this.currentVolume=0,this.messages=[],this.ui=null,this.mode="idle",this.sessionValidationInProgress=!1,this.meetingUrl=this.config.meetingUrl,this.toolHandlers={},this._startSessionInProgress=!1,this.debug=this.config.debug||!1;let t=!(this.logger={log:(e,...t)=>{console.log(e,...t)},debug:(e,...t)=>{this.debug&&console.log("[DEBUG] "+e,...t)},error:(e,...t)=>{console.error(e,...t)},warn:(e,...t)=>{console.warn(e,...t)}});if(this.clientId||(console.error("Voice AI SDK: Client ID is required. Please provide a valid clientId in the configuration."),t=!0),this.config.serverUrl||(console.error("Voice AI SDK: Server URL is required. Please provide a valid serverUrl in the configuration."),console.error('Example: serverUrl: "https://voice-ai-sandy.vercel.app"'),t=!0),this.meetingUrl||(console.error("Voice AI SDK: Meeting URL is required. Please provide a valid meetingUrl in the configuration."),console.error('Example: meetingUrl: "https://calendly.com/your-company/meeting"'),t=!0),this.config.serverUrl)try{new URL(this.config.serverUrl)}catch(e){console.error(`Voice AI SDK: Invalid Server URL "${this.config.serverUrl}". Please provide a valid URL.`),t=!0}if(this.meetingUrl)try{new URL(this.meetingUrl)}catch(e){console.error(`Voice AI SDK: Invalid Meeting URL "${this.meetingUrl}". Please provide a valid URL.`),t=!0}console.log("Voice AI SDK: Current domain:",u.location.hostname),console.log("Voice AI SDK: Server URL:",this.config.serverUrl),t?console.error("Voice AI SDK: Initialization failed due to configuration errors."):this._init()}async _init(){try{await this._loadSession(),await this._validateClient(),await this._initSession(),this._createUI(),this._registerEventListeners(),this._registerToolHandlers(),"function"==typeof this.config.onReady&&this.config.onReady()}catch(e){console.error("Voice AI SDK: Initialization error",e),"function"==typeof this.config.onError&&this.config.onError(e)}}_registerToolHandlers(){this.toolHandlers.show_booking_popup=e=>this._showBookingPopup(e.message),console.log("Voice AI SDK: Registered tool handlers",Object.keys(this.toolHandlers))}_showBookingPopup(e){console.log("Voice AI SDK: Showing booking popup",e);let t=document.createElement("div");t.className="voice-ai-booking-popup",t.style.position="fixed",t.style.bottom="100px",t.style.right="20px",t.style.width="300px",t.style.padding="20px",t.style.backgroundColor="#ffffff",t.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",t.style.borderRadius="8px",t.style.zIndex="10000",t.style.fontFamily="Arial, sans-serif",t.style.display="flex",t.style.flexDirection="column",t.style.gap="15px";var i=document.createElement("div");i.textContent=e||"Please book a meeting with our team",i.style.fontSize="14px",i.style.lineHeight="1.5",i.style.color="#333333";let o=document.createElement("a");o.href=this.meetingUrl,o.target="_blank",o.textContent="Book a Meeting",o.style.display="inline-block",o.style.padding="10px 16px",o.style.backgroundColor="#4a90e2",o.style.color="#ffffff",o.style.textDecoration="none",o.style.borderRadius="4px",o.style.fontWeight="bold",o.style.textAlign="center",o.style.cursor="pointer",o.style.transition="background-color 0.2s",o.onmouseover=()=>{o.style.backgroundColor="#3a80d2"},o.onmouseout=()=>{o.style.backgroundColor="#4a90e2"};e=document.createElement("button");return e.textContent="Ã—",e.style.position="absolute",e.style.top="10px",e.style.right="10px",e.style.background="none",e.style.border="none",e.style.fontSize="20px",e.style.cursor="pointer",e.style.color="#999999",e.style.padding="0",e.style.lineHeight="1",e.onclick=()=>{document.body.removeChild(t)},t.appendChild(e),t.appendChild(i),t.appendChild(o),document.body.appendChild(t),setTimeout(()=>{document.body.contains(t)&&document.body.removeChild(t)},3e4),setTimeout(()=>{this.isActive&&(console.log("Voice AI SDK: Auto-stopping session after showing booking popup"),this.stopSession())},1e4),{success:!0,message:"Booking popup displayed"}}async _loadSession(){try{var e,t=localStorage.getItem("voice_ai_session");t?(e=JSON.parse(t)).clientId===this.clientId?(console.log("Voice AI SDK: Found saved session",e.sessionId),await this._validateSession(e.sessionId)?(this.sessionId=e.sessionId,console.log("Voice AI SDK: Session validated successfully",this.sessionId)):(console.log("Voice AI SDK: Saved session is invalid, will create a new one"),localStorage.removeItem("voice_ai_session"),this.sessionId=null)):(console.log("Voice AI SDK: Saved session belongs to different client, will create a new one"),localStorage.removeItem("voice_ai_session")):console.log("Voice AI SDK: No saved session found")}catch(e){console.error("Voice AI SDK: Failed to load session",e),localStorage.removeItem("voice_ai_session"),this.sessionId=null}}async _validateSession(e){if(this.sessionValidationInProgress)return console.log("Voice AI SDK: Session validation already in progress"),!1;this.sessionValidationInProgress=!0;try{console.log("Voice AI SDK: Validating session",e);try{if((await fetch(this.config.serverUrl+"/api/v1/sessions?sessionId="+e,{method:"GET"})).ok)return this.sessionValidationInProgress=!1,console.log("Voice AI SDK: Session validated successfully"),!0}catch(e){console.error("Voice AI SDK: Error during session validation",e)}return console.log("Voice AI SDK: Session validation failed"),this.sessionValidationInProgress=!1}catch(e){return console.error("Voice AI SDK: Session validation failed",e),this.sessionValidationInProgress=!1}}_saveSession(){try{localStorage.setItem("voice_ai_session",JSON.stringify({clientId:this.clientId,sessionId:this.sessionId})),console.log("Voice AI SDK: Session saved to localStorage",this.sessionId)}catch(e){console.error("Voice AI SDK: Failed to save session",e)}}async _validateClient(){try{console.log(`Voice AI SDK: Validating client "${this.clientId}" with server at "${this.config.serverUrl}"`),console.log("Voice AI SDK: Current page URL: "+u.location.href);var e=this.config.serverUrl+"/api/v1/auth/validate",t=(console.log("Voice AI SDK: Validation endpoint: "+e),await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:this.clientId})}));if(!t.ok){var i=t.status;let e;try{e=await t.json()}catch(e){throw new Error(`Server returned ${i} status code. Check if your domain is authorized for this client ID.`)}throw 403===i?(console.error(`Voice AI SDK: Domain "${u.location.hostname}" is not authorized for client "${this.clientId}".`),console.error("Voice AI SDK: Make sure your domain is added to the CLIENT_"+this.clientId+"_DOMAINS environment variable on the server."),new Error(e.error||"Domain not authorized. Status: "+i)):new Error(e.error||"Client validation failed. Status: "+i)}var o=await t.json();if(!o.valid)throw new Error(o.error||"Client validation failed: Server returned invalid status");console.log("Voice AI SDK: Client validated successfully")}catch(e){throw console.error("Voice AI SDK: Client validation failed",e),(e.message.includes("NetworkError")||e.message.includes("Failed to fetch"))&&(console.error("Voice AI SDK: Network error occurred. This might be due to CORS restrictions."),console.error(`Voice AI SDK: Make sure your domain "${u.location.hostname}" is added to the CLIENT_${this.clientId}_DOMAINS environment variable on the server.`),console.error(`Voice AI SDK: Also check that the serverUrl "${this.config.serverUrl}" is correct and accessible.`)),e}}async _initSession(){try{if(this.sessionId)this.logger.log("Using existing session",this.sessionId);else{this.logger.log("Creating new session");try{var e=await fetch(this.config.serverUrl+"/api/v1/sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:this.clientId})}),t=await e.json();if(!e.ok)throw new Error(t.error||"Failed to create session");this.sessionId=t.sessionId,this.logger.log("New session created",this.sessionId),this._saveSession(),this.logger.debug("Waiting for session to be fully registered..."),await new Promise(e=>setTimeout(e,500))}catch(e){throw e}}}catch(e){throw this.logger.error("Session initialization failed",e),e}}_createUI(){var e=document.createElement("div");switch(e.className="voice-ai-container",e.style.position="fixed",this.config.position){case"bottom-right":e.style.bottom="20px",e.style.right="20px";break;case"bottom-left":e.style.bottom="20px",e.style.left="20px";break;case"top-right":e.style.top="20px",e.style.right="20px";break;case"top-left":e.style.top="20px",e.style.left="20px";break;default:e.style.bottom="20px",e.style.right="20px"}var t=document.createElement("div"),i=(t.className="voice-ai-button",t.style.width="64px",t.style.height="64px",t.style.borderRadius="50%",t.style.backgroundColor=this.config.customStyles.buttonColor||"#3a86ff",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.cursor="pointer",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)",t.style.transition="all 0.3s ease",document.createElement("div")),o=(i.className="voice-ai-animation",i.style.width="100%",i.style.height="100%",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",document.createElement("div")),n=(o.className="voice-ai-idle-animation",o.style.width="32px",o.style.height="32px",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.animation="voice-ai-pulse 2s infinite",document.createElement("img")),n=(n.src=`${this.config.serverUrl||""}/microphone.svg`,n.alt="Microphone",n.style.width="24px",n.style.height="24px",o.appendChild(n),i.appendChild(o),t.appendChild(i),e.appendChild(t),document.createElement("style"));n.textContent=`
          @keyframes voice-ai-pulse {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.5; }
          }
          
          @keyframes voice-ai-thinking {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
          }
          
          @keyframes voice-ai-volume {
            0% { height: 10px; }
            50% { height: 30px; }
            100% { height: 10px; }
          }
        `,document.head.appendChild(n),document.body.appendChild(e),this.ui={container:e,button:t,animationContainer:i,idleAnimation:o},t.addEventListener("click",()=>{this.toggleSession()})}_registerEventListeners(){u.addEventListener("beforeunload",()=>{this.isActive&&this.stopSession()})}_updateUI(e,n=0){if(this.uiMode=e,this.ui){var t=this.ui.button,i=this.ui.animationContainer,o=this.ui.container.querySelector(".voice-ai-status");this.ui.idleAnimation?.querySelector("img");if(t&&i){for(;i.firstChild;)i.removeChild(i.firstChild);switch(e){case"loading":var s=document.createElement("div");s.className="voice-ai-loading-animation",i.appendChild(s),o&&(o.textContent="Connecting...");break;case"active":var r=document.createElement("div");r.className="voice-ai-volume-container";for(let e=0;e<4;e++){var a=document.createElement("div");a.className="voice-ai-volume-bar",a.style.width="4px",a.style.backgroundColor="#ffffff",a.style.borderRadius="2px",a.style.height="10px",a.style.transition="height 0.3s ease-in-out",r.appendChild(a)}i.appendChild(r),this.ui.volumeBars=Array.from(r.querySelectorAll(".voice-ai-volume-bar")),o&&(o.textContent="Listening...");break;case"thinking":s=document.createElement("div");s.className="voice-ai-thinking-animation",i.appendChild(s),o&&(o.textContent="Thinking...");break;case"responding":s=document.createElement("div");s.className="voice-ai-responding-animation",i.appendChild(s),o&&(o.textContent="Responding...");break;case"error":var s=document.createElement("div"),l=(s.className="voice-ai-error-animation",s.style.backgroundColor="#ff3b30",document.createElement("div"));l.className="voice-ai-error-pulse",s.appendChild(l),i.appendChild(s),o&&(o.textContent="Error"),setTimeout(()=>{"error"===this.uiMode&&(this._updateUI("idle"),this.isActive)&&(this._cleanupWebRTC(),this.isActive=!1,this.isListening=!1,setTimeout(()=>{this.startSession()},1e3))},5e3);break;case"volume":if(this.ui.volumeBars&&0<this.ui.volumeBars.length&&i.querySelector(".voice-ai-volume-container"))this.ui.volumeBars.forEach((e,t)=>{var i=.9+.2*Math.random(),i=Math.max(10,Math.min(30,400*n*i)),o=u.getComputedStyle(e),o=parseInt(o.height,10);e.style.height=.7*o+.3*i+"px"});else{var c=document.createElement("div");c.className="voice-ai-volume-container",this.ui.volumeBars=[];for(let e=0;e<4;e++){var h=document.createElement("div"),d=(h.className="voice-ai-volume-bar",h.style.width="4px",h.style.backgroundColor="#ffffff",h.style.borderRadius="2px",h.style.transition="height 0.3s ease-in-out",.9+.2*Math.random()),d=Math.max(10,Math.min(30,400*n*d));h.style.height=d+"px",c.appendChild(h),this.ui.volumeBars.push(h)}i.appendChild(c)}o&&(o.textContent="Listening...");break;default:l=document.createElement("div"),s=(l.className="voice-ai-idle-animation",document.createElement("img"));s.src=`${this.config.serverUrl||""}/microphone.svg`,s.alt="Microphone",s.style.width="24px",s.style.height="24px",l.appendChild(s),i.appendChild(l),this.ui.idleAnimation=l,o&&(o.textContent="Click to talk")}}}}async _configureSession(){try{this.logger.log("Configuring session with ID:",this.sessionId);var e=await this.peerConnection.createOffer(),t=(await this.peerConnection.setLocalDescription(e),await fetch(this.config.serverUrl+"/api/v1/voice/process",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:this.clientId,sessionId:this.sessionId,offer:this.peerConnection.localDescription,voice:this.config.voice||"alloy"})})),i=await t.json();if(t.ok)return await this.peerConnection.setRemoteDescription(i.answer),this.instructions=i.instructions,!0;var o=i.error||"Failed to configure session";if(404===t.status&&i.newSessionId)return this.logger.log("Server provided new session ID:",i.newSessionId),this.sessionId=i.newSessionId,this._saveSession(),this.logger.debug("Waiting for session to be fully registered..."),new Promise(e=>{setTimeout(async()=>{this.logger.debug("Retrying with new session ID"),e(await this._configureSession())},1e3)});if(404===t.status&&o.includes("Session not found"))return this.logger.log("Session not found, creating a new one"),this.sessionId=null,localStorage.removeItem("voice_ai_session"),await this._initSession(),this.logger.debug("Waiting for session to be fully registered..."),new Promise(e=>{setTimeout(async()=>{this.logger.debug("Retrying with new session ID"),e(await this._configureSession())},1e3)});throw new Error(o)}catch(e){throw this.logger.error("Session configuration failed",e),this._updateUI("error"),e}}_onDataChannelOpen(){this.logger.log("Data channel opened"),setTimeout(()=>{this._configureDataChannel(),this._updateUI("responding")},500)}_configureDataChannel(){this.dataChannel?"open"!==this.dataChannel.readyState?(this.logger.error("Data channel not open, cannot configure. State:",this.dataChannel.readyState),this._updateUI("error")):(this.logger.log("Configuring data channel"),(async()=>{try{this.logger.debug("Sending session update");var e,t,i={type:"session.update",session:{modalities:["text","audio"],tools:[{type:"function",name:"show_booking_popup",description:'Show a popup with a button to book a meeting. Use when: (1) User wants to learn more about Improvado, (2) User wants to schedule a demo/meeting, (3) User asks about pricing/implementation details, (4) Conversation requires human representative, (5) User explicitly asks to book a meeting. Provide personalized message about benefits. When using this tool, tell the user directly: "I\'ve opened a booking popup for you. Please click the button to schedule a meeting." After using, end conversation with: "I\'ll be here when you\'re ready to continue. Just click the microphone button again."',parameters:{type:"object",properties:{}}}],turn_detection:{type:"server_vad",threshold:.5,prefix_padding_ms:300,silence_duration_ms:200,create_response:!0},instructions:this.instructions}};this.dataChannel&&"open"===this.dataChannel.readyState?(await this.dataChannel.send(JSON.stringify(i)),this.dataChannel&&"open"===this.dataChannel.readyState&&(this.logger.debug("Sending initial message"),e={type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:"Begin the conversation by introducing yourself as an Improvado representative"}]}},await this.dataChannel.send(JSON.stringify(e)),this.dataChannel)&&"open"===this.dataChannel.readyState?(this.logger.debug("Requesting response creation"),t={type:"response.create"},await this.dataChannel.send(JSON.stringify(t))):(this.logger.error("Data channel closed while configuring"),this._updateUI("error"))):(this.logger.error("Data channel closed while configuring"),this._updateUI("error"))}catch(e){this.logger.error("Error sending messages:",e),this._updateUI("error"),"function"==typeof this.config.onError&&this.config.onError(new Error("Error configuring data channel: "+e.message))}})()):(this.logger.error("Data channel not available, cannot configure"),this._updateUI("error"))}_onDataChannelMessage(e){try{var t=JSON.parse(e.data);switch(this.logger.debug("Received message",t),t.type){case"thinking":this._updateUI("thinking");break;case"responding":this._updateUI("responding");break;case"response":this.messages.push({role:"assistant",content:t.content}),"function"==typeof this.config.onMessage&&this.config.onMessage({role:"assistant",content:t.content}),this._updateUI("responding");break;case"function_call":if(this.logger.log("Function call received",t.function_call),t.function_call&&t.function_call.name){var i,o,n=t.function_call.name,s=t.function_call.arguments||{},r=t.function_call.id||"unknown";if(this.toolHandlers[n])try{var a,l=this.toolHandlers[n](s);this.dataChannel&&"open"===this.dataChannel.readyState&&(a={type:"function_call_response",function_call_id:r,result:l},this.dataChannel.send(JSON.stringify(a)))}catch(e){console.error("Voice AI SDK: Error executing function "+n,e),this.dataChannel&&"open"===this.dataChannel.readyState&&(o={type:"function_call_response",function_call_id:r,error:e.message||"Error executing function"},this.dataChannel.send(JSON.stringify(o))),this._updateUI("error")}else console.error(`Voice AI SDK: Function ${n} not found`),this.dataChannel&&"open"===this.dataChannel.readyState&&(i={type:"function_call_response",function_call_id:r,error:`Function ${n} not found`},this.dataChannel.send(JSON.stringify(i))),this._updateUI("error")}else console.error("Voice AI SDK: Invalid function call format",t),this._updateUI("error");break;case"response.function_call_arguments.done":if(console.log("Voice AI SDK: Function call received from OpenAI",t),t.name){var c=t.name;let e={};var h,d,u=t.call_id||"unknown";try{t.arguments&&(e=JSON.parse(t.arguments))}catch(e){console.error("Voice AI SDK: Error parsing function arguments",e)}if(this.toolHandlers[c])try{this.lastFunctionCalled=c;var g,p=this.toolHandlers[c](e);this.dataChannel&&"open"===this.dataChannel.readyState&&(g={type:"conversation.item.create",item:{type:"function_call_output",call_id:u,output:JSON.stringify(p)}},this.dataChannel.send(JSON.stringify(g)))}catch(e){console.error("Voice AI SDK: Error executing function "+c,e),this.dataChannel&&"open"===this.dataChannel.readyState&&(d={type:"conversation.item.create",item:{type:"function_call_output",call_id:u,output:JSON.stringify({error:e.message||"Error executing function"})}},this.dataChannel.send(JSON.stringify(d))),this._updateUI("error")}else console.error(`Voice AI SDK: Function ${c} not found`),this.dataChannel&&"open"===this.dataChannel.readyState&&(h={type:"conversation.item.create",item:{type:"function_call_output",call_id:u,output:JSON.stringify({error:`Function ${c} not found`})}},this.dataChannel.send(JSON.stringify(h))),this._updateUI("error")}else console.error("Voice AI SDK: Invalid function call format from OpenAI",t),this._updateUI("error");break;case"error":console.error("Voice AI SDK: Error from server",t.error),"function"==typeof this.config.onError&&this.config.onError(new Error(t.error)),this._updateUI("error");break;case"input_audio_buffer.speech_started":this._updateUI("volume",this.currentVolume||.1);break;case"input_audio_buffer.speech_ended":case"output_audio_buffer.started":case"output_audio_buffer.ended":this._updateUI("responding")}}catch(e){console.error("Voice AI SDK: Error parsing message",e)}}_onDataChannelClose(){this.logger.log("Data channel closed"),this.isListening=!1,this._updateUI("idle"),this.isActive&&(this.isActive=!1,"function"==typeof this.config.onEnd)&&this.config.onEnd()}_onDataChannelError(e){this.logger.error("Data channel error",e),this._updateUI("error"),"function"==typeof this.config.onError&&this.config.onError(new Error("Data channel error: "+(e.message||"Unknown error"))),this._cleanupWebRTC(),this.isActive=!1,this.isListening=!1}_onIceCandidate(e){e.candidate&&this.logger.debug("New ICE candidate",e.candidate)}_onConnectionStateChange(){if(this.peerConnection)switch(this.logger.debug("Connection state changed to",this.peerConnection.connectionState),this.peerConnection.connectionState){case"connected":this.logger.log("WebRTC connection established");break;case"disconnected":this.logger.log("WebRTC connection disconnected, attempting to recover"),this._updateUI("error"),"function"==typeof this.config.onError&&this.config.onError(new Error("WebRTC connection disconnected, attempting to recover")),setTimeout(()=>{!this.peerConnection||"disconnected"!==this.peerConnection.connectionState&&"failed"!==this.peerConnection.connectionState||(this.logger.log("WebRTC connection failed to recover, cleaning up"),this._cleanupWebRTC(),this.isActive=!1,this.isListening=!1,"function"==typeof this.config.onEnd&&this.config.onEnd())},5e3);break;case"failed":this.logger.error("WebRTC connection failed"),this._updateUI("error"),"function"==typeof this.config.onError&&this.config.onError(new Error("WebRTC connection failed")),this._cleanupWebRTC(),this.isActive=!1,this.isListening=!1,"function"==typeof this.config.onEnd&&this.config.onEnd();break;case"closed":this.logger.log("WebRTC connection closed"),this._updateUI("inactive")}}_cleanupWebRTC(){if(this.logger.log("Cleaning up WebRTC resources"),this.dataChannel){try{this.dataChannel.close()}catch(e){this.logger.error("Error closing data channel",e)}this.dataChannel=null}if(this.peerConnection){try{this.peerConnection.onicecandidate=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.ontrack=null,this.peerConnection.close()}catch(e){this.logger.error("Error closing peer connection",e)}this.peerConnection=null}if(this.stream){try{this.stream.getTracks().forEach(e=>{e.stop()})}catch(e){this.logger.error("Error stopping media stream",e)}this.stream=null}if(this.audioElement){try{this.audioElement.srcObject=null,this.audioElement.remove()}catch(e){this.logger.error("Error cleaning up audio element",e)}this.audioElement=null}this.isActive=!1,this.isListening=!1}async startSession(){if(!this.isActive&&!this._startSessionInProgress){this._startSessionInProgress=!0;try{this._updateUI("loading"),await this._initWebRTC()?(await this._configureSession(),this.isActive=!0,this.isListening=!0,"function"==typeof this.config.onStart&&this.config.onStart()):(this._updateUI("error"),this._startSessionInProgress=!1)}catch(e){this.logger.error("Failed to start session",e),this._cleanupWebRTC(),this._updateUI("error"),"function"==typeof this.config.onError&&this.config.onError(e)}finally{this._startSessionInProgress=!1}}}stopSession(){this.logger.log("Stopping session"),this.isActive||this._startSessionInProgress?(this.volumeInterval&&(clearInterval(this.volumeInterval),this.volumeInterval=null),this.volumeTimeout&&(clearTimeout(this.volumeTimeout),this.volumeTimeout=null),this.audioContext&&(this.audioContext.close().catch(console.error),this.audioContext=null,this.analyser=null),this.stream&&(this.stream.getTracks().forEach(e=>{e.stop()}),this.stream=null),this._cleanupWebRTC(),this.isActive=!1,this.isListening=!1,this.currentVolume=0,this._startSessionInProgress=!1,this._updateUI("idle"),"function"==typeof this.config.onEnd&&this.config.onEnd()):this.logger.debug("Session already stopped")}toggleSession(){this.isActive?this.stopSession():(this._updateUI("loading"),this.startSession())}async _initWebRTC(){try{this.logger.log("Initializing WebRTC"),this._cleanupWebRTC(),this.peerConnection=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),this.peerConnection.onicecandidate=this._onIceCandidate.bind(this),this.peerConnection.onconnectionstatechange=this._onConnectionStateChange.bind(this);try{this.stream=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(e){return this.logger.error("Error accessing microphone",e),"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?(this.logger.error("Microphone permission denied"),alert("Voice AI requires microphone access. Please allow microphone access and try again.")):alert("Error accessing microphone. Please check your device settings and try again."),!1}this._setupAudioVisualization(this.stream),this.stream.getAudioTracks().forEach(e=>{this.peerConnection.addTrack(e,this.stream)}),this.audioElement=document.createElement("audio"),this.audioElement.autoplay=!0,this.peerConnection.ontrack=e=>{this.logger.debug("Received audio track"),this.audioElement.srcObject=e.streams[0]},this.dataChannel=this.peerConnection.createDataChannel("response"),this.dataChannel.onopen=this._onDataChannelOpen.bind(this),this.dataChannel.onmessage=this._onDataChannelMessage.bind(this),this.dataChannel.onclose=this._onDataChannelClose.bind(this),this.dataChannel.onerror=this._onDataChannelError.bind(this);var e=await this.peerConnection.createOffer();return await this.peerConnection.setLocalDescription(e),this.logger.debug("Created offer"),!0}catch(e){return this.logger.error("Error initializing WebRTC",e),this._updateUI("error"),!1}}_setupAudioVisualization(e){try{var i=new(u.AudioContext||u.webkitAudioContext),o=i.createMediaStreamSource(e);let r=i.createAnalyser();r.fftSize=256,o.connect(r);var n=r.frequencyBinCount;let a=new Uint8Array(n),t=(this.volumeHistory=Array(5).fill(.1),()=>{r.getByteTimeDomainData(a);let t=0;for(let e=0;e<a.length;e++){var i=(a[e]-128)/128;t+=i*i}var e=Math.sqrt(t/a.length);this.volumeHistory.push(e),this.volumeHistory.shift();let o=0,n=0;for(let e=0;e<this.volumeHistory.length;e++){var s=e+1;o+=this.volumeHistory[e]*s,n+=s}return Math.max(.05,o/n)});this.volumeInterval=setInterval(()=>{var e;this.isActive&&this.isListening&&"volume"===this.uiMode&&(e=t(),this._updateUI("volume",e)),this.currentVolume=t()},100),this.audioContext=i,this.analyser=r}catch(e){console.error("Voice AI SDK: Error setting up audio visualization",e)}}_startVolumeDetection(){if(this.analyser){let s=this.analyser.frequencyBinCount,r=new Uint8Array(s);this.volumeHistory||(this.volumeHistory=Array(5).fill(0)),this.volumeInterval=setInterval(()=>{if(this.analyser){this.analyser.getByteFrequencyData(r);let t=0;for(let e=0;e<s;e++)t+=r[e];var e=t/s/255;this.volumeHistory.push(e),this.volumeHistory.shift();let i=0,o=0;for(let e=0;e<this.volumeHistory.length;e++){var n=e+1;i+=this.volumeHistory[e]*n,o+=n}this.currentVolume=i/o,this.isListening&&"volume"===this.uiMode&&this._updateUI("volume",this.currentVolume)}},100)}}_stopVolumeDetection(){this.volumeInterval&&(clearInterval(this.volumeInterval),this.volumeInterval=null)}}u.VoiceAI={init:e=>new t(e)}})(window);