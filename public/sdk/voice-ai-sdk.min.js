(a=>{let i={position:"bottom-right",theme:"light",language:"en",customStyles:{}};class t{constructor(e){this.config={...i,...e},this.clientId=this.config.clientId,this.sessionId=null,this.isActive=!1,this.isListening=!1,this.audioContext=null,this.mediaStream=null,this.peerConnection=null,this.dataChannel=null,this.analyser=null,this.volumeInterval=null,this.currentVolume=0,this.messages=[],this.ui=null,this.mode="idle";let t=this.sessionValidationInProgress=!1;if(this.clientId||(console.error("Voice AI SDK: Client ID is required. Please provide a valid clientId in the configuration."),t=!0),this.config.serverUrl||(console.error("Voice AI SDK: Server URL is required. Please provide a valid serverUrl in the configuration."),console.error('Example: serverUrl: "https://voice-ai-sandy.vercel.app"'),t=!0),this.config.serverUrl)try{new URL(this.config.serverUrl)}catch(e){console.error(`Voice AI SDK: Invalid Server URL "${this.config.serverUrl}". Please provide a valid URL.`),t=!0}console.log("Voice AI SDK: Current domain:",a.location.hostname),console.log("Voice AI SDK: Server URL:",this.config.serverUrl),t?console.error("Voice AI SDK: Initialization failed due to configuration errors."):this._init()}async _init(){try{await this._loadSession(),await this._validateClient(),await this._initSession(),this._createUI(),this._registerEventListeners(),"function"==typeof this.config.onReady&&this.config.onReady()}catch(e){console.error("Voice AI SDK: Initialization failed",e),"function"==typeof this.config.onError&&this.config.onError(e)}}async _loadSession(){try{var e,t=localStorage.getItem("voice_ai_session");t?(e=JSON.parse(t)).clientId===this.clientId?(console.log("Voice AI SDK: Found saved session",e.sessionId),await this._validateSession(e.sessionId)?(this.sessionId=e.sessionId,console.log("Voice AI SDK: Session validated successfully",this.sessionId)):(console.log("Voice AI SDK: Saved session is invalid, will create a new one"),localStorage.removeItem("voice_ai_session"),this.sessionId=null)):(console.log("Voice AI SDK: Saved session belongs to different client, will create a new one"),localStorage.removeItem("voice_ai_session")):console.log("Voice AI SDK: No saved session found")}catch(e){console.error("Voice AI SDK: Failed to load session",e),localStorage.removeItem("voice_ai_session"),this.sessionId=null}}async _validateSession(e){if(this.sessionValidationInProgress)return console.log("Voice AI SDK: Session validation already in progress"),!1;this.sessionValidationInProgress=!0;try{console.log("Voice AI SDK: Validating session",e);var t=await fetch(this.config.serverUrl+"/api/v1/sessions?sessionId="+e,{method:"GET"});return this.sessionValidationInProgress=!1,t.ok}catch(e){return console.error("Voice AI SDK: Session validation failed",e),this.sessionValidationInProgress=!1}}_saveSession(){try{localStorage.setItem("voice_ai_session",JSON.stringify({clientId:this.clientId,sessionId:this.sessionId})),console.log("Voice AI SDK: Session saved to localStorage",this.sessionId)}catch(e){console.error("Voice AI SDK: Failed to save session",e)}}async _validateClient(){try{console.log(`Voice AI SDK: Validating client "${this.clientId}" with server at "${this.config.serverUrl}"`),console.log("Voice AI SDK: Current page URL: "+a.location.href);var e=this.config.serverUrl+"/api/v1/auth/validate",t=(console.log("Voice AI SDK: Validation endpoint: "+e),await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:this.clientId})}));if(!t.ok){var i=t.status;let e;try{e=await t.json()}catch(e){throw new Error(`Server returned ${i} status code. Check if your domain is authorized for this client ID.`)}throw 403===i?(console.error(`Voice AI SDK: Domain "${a.location.hostname}" is not authorized for client "${this.clientId}".`),console.error("Voice AI SDK: Make sure your domain is added to the CLIENT_"+this.clientId+"_DOMAINS environment variable on the server."),new Error(e.error||"Domain not authorized. Status: "+i)):new Error(e.error||"Client validation failed. Status: "+i)}var o=await t.json();if(!o.valid)throw new Error(o.error||"Client validation failed: Server returned invalid status");console.log("Voice AI SDK: Client validated successfully")}catch(e){throw console.error("Voice AI SDK: Client validation failed",e),(e.message.includes("NetworkError")||e.message.includes("Failed to fetch"))&&(console.error("Voice AI SDK: Network error occurred. This might be due to CORS restrictions."),console.error(`Voice AI SDK: Make sure your domain "${a.location.hostname}" is added to the CLIENT_${this.clientId}_DOMAINS environment variable on the server.`),console.error(`Voice AI SDK: Also check that the serverUrl "${this.config.serverUrl}" is correct and accessible.`)),e}}async _initSession(){try{if(this.sessionId)console.log("Voice AI SDK: Using existing session",this.sessionId);else{console.log("Voice AI SDK: Creating new session");var e=await fetch(this.config.serverUrl+"/api/v1/sessions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:this.clientId})}),t=await e.json();if(!e.ok)throw new Error(t.error||"Failed to create session");this.sessionId=t.sessionId,console.log("Voice AI SDK: New session created",this.sessionId),this._saveSession()}}catch(e){throw console.error("Voice AI SDK: Session initialization failed",e),e}}_createUI(){var e=document.createElement("div");switch(e.className="voice-ai-container",e.style.position="fixed",this.config.position){case"bottom-right":e.style.bottom="20px",e.style.right="20px";break;case"bottom-left":e.style.bottom="20px",e.style.left="20px";break;case"top-right":e.style.top="20px",e.style.right="20px";break;case"top-left":e.style.top="20px",e.style.left="20px";break;default:e.style.bottom="20px",e.style.right="20px"}var t=document.createElement("div"),i=(t.className="voice-ai-button",t.style.width="64px",t.style.height="64px",t.style.borderRadius="50%",t.style.backgroundColor=this.config.customStyles.buttonColor||"#3a86ff",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.cursor="pointer",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)",t.style.transition="all 0.3s ease",document.createElement("div")),o=(i.className="voice-ai-animation",i.style.width="100%",i.style.height="100%",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",document.createElement("div")),s=(o.className="voice-ai-idle-animation",o.style.width="32px",o.style.height="32px",o.style.borderRadius="50%",o.style.backgroundColor="#ffffff",o.style.opacity="0.8",o.style.animation="voice-ai-pulse 2s infinite",i.appendChild(o),t.appendChild(i),e.appendChild(t),document.createElement("style"));s.textContent=`
          @keyframes voice-ai-pulse {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.5; }
          }
          
          @keyframes voice-ai-thinking {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
          }
          
          @keyframes voice-ai-volume {
            0% { height: 10px; }
            50% { height: 30px; }
            100% { height: 10px; }
          }
        `,document.head.appendChild(s),document.body.appendChild(e),this.ui={container:e,button:t,animationContainer:i,idleAnimation:o},t.addEventListener("click",()=>{this.toggleSession()})}_registerEventListeners(){a.addEventListener("beforeunload",()=>{this.isActive&&this.stopSession()})}_updateUI(e,i=0){if(this.uiMode=e,this.ui){var o=this.ui.button,s=this.ui.animationContainer,n=this.ui.container.querySelector(".voice-ai-status");if(o&&s)switch(o.classList.remove("voice-ai-active","voice-ai-thinking","voice-ai-responding","voice-ai-error"),e){case"active":o.classList.add("voice-ai-active"),n&&(n.textContent="Listening...");break;case"thinking":o.classList.add("voice-ai-thinking"),n&&(n.textContent="Thinking...");break;case"responding":o.classList.add("voice-ai-responding"),n&&(n.textContent="Responding...");break;case"error":o.classList.add("voice-ai-error"),n&&(n.textContent="Error");break;case"volume":o.classList.add("voice-ai-active"),n&&(n.textContent="Listening...");let t=this.ui.animationContainer.querySelector(".voice-ai-volume-indicator");if(!t){(t=document.createElement("div")).className="voice-ai-volume-indicator",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="flex-end",t.style.height="50px",t.style.gap="5px",t.style.position="absolute",t.style.bottom="80px",t.style.left="50%",t.style.transform="translateX(-50%)";for(let e=0;e<4;e++){var a=document.createElement("div");a.className="voice-ai-volume-bar",a.style.width="4px",a.style.backgroundColor="#3b82f6",a.style.borderRadius="2px",a.style.height="10px",a.style.transition="height 0.1s ease",t.appendChild(a)}s.appendChild(t)}t.querySelectorAll(".voice-ai-volume-bar").forEach(e=>{var t=.8+.4*Math.random(),t=Math.max(10,Math.min(50,500*i*t));e.style.height=t+"px"}),t.style.display="flex";break;default:n&&(n.textContent="Click to talk");var r=this.ui.animationContainer.querySelector(".voice-ai-volume-indicator");r&&(r.style.display="none")}}}async _configureSession(){try{console.log("Voice AI SDK: Configuring session with ID:",this.sessionId);var e=await this.peerConnection.createOffer(),t=(await this.peerConnection.setLocalDescription(e),await fetch(this.config.serverUrl+"/api/v1/voice/process",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:this.clientId,sessionId:this.sessionId,offer:this.peerConnection.localDescription,voice:this.config.voice||"alloy"})})),i=await t.json();if(t.ok)return await this.peerConnection.setRemoteDescription(i.answer),this.instructions=i.instructions,this._updateUI("idle"),!0;var o=i.error||"Failed to configure session";if(404===t.status&&i.newSessionId)return console.log("Voice AI SDK: Server provided new session ID:",i.newSessionId),this.sessionId=i.newSessionId,this._saveSession(),this._configureSession();if(404===t.status&&o.includes("Session not found"))return console.log("Voice AI SDK: Session not found, creating a new one"),this.sessionId=null,localStorage.removeItem("voice_ai_session"),await this._initSession(),this._configureSession();throw new Error(o)}catch(e){throw console.error("Voice AI SDK: Session configuration failed",e),this._updateUI("error"),e}}_onDataChannelOpen(){console.log("Voice AI SDK: Data channel opened"),this._configureDataChannel(),this._updateUI("idle")}_configureDataChannel(){this.dataChannel&&"open"===this.dataChannel.readyState?(console.log("Voice AI SDK: Configuring data channel"),(async()=>{try{console.log("Voice AI SDK: Sending session update");var e,t,i={type:"session.update",session:{modalities:["text","audio"],tools:[],turn_detection:{type:"server_vad",threshold:.5,prefix_padding_ms:300,silence_duration_ms:200,create_response:!0},instructions:this.instructions}};this.dataChannel&&"open"===this.dataChannel.readyState&&(this.dataChannel.send(JSON.stringify(i)),await new Promise(e=>setTimeout(e,300)),this.dataChannel)&&"open"===this.dataChannel.readyState&&(console.log("Voice AI SDK: Sending initial message"),e={type:"conversation.item.create",item:{type:"message",role:"user",content:[{type:"input_text",text:"Begin the conversation by introducing yourself as an Improvado representative"}]}},this.dataChannel.send(JSON.stringify(e)),await new Promise(e=>setTimeout(e,300)),this.dataChannel)&&"open"===this.dataChannel.readyState&&(console.log("Voice AI SDK: Requesting response creation"),t={type:"response.create"},this.dataChannel.send(JSON.stringify(t)))}catch(e){console.error("Voice AI SDK: Error sending messages:",e)}})()):console.log("Voice AI SDK: Data channel not open, cannot configure")}_onDataChannelMessage(e){try{if(e.data){var t=JSON.parse(e.data);if(t.type){switch(console.log("Voice AI SDK: Received message",t.type),this.messages.push(t),t.type){case"input_audio_buffer.speech_started":console.log("Voice AI SDK: Speech started"),this._updateUI("thinking");break;case"conversation.item.created":console.log("Voice AI SDK: Conversation item created"),this._updateUI("responding");break;case"conversation.item.completed":console.log("Voice AI SDK: Conversation item completed"),this._updateUI("idle");break;case"response.function_call_arguments.done":console.log("Voice AI SDK: Function call arguments done")}var i=new CustomEvent("voice-ai-message",{detail:{message:t}});a.dispatchEvent(i)}else console.warn("Voice AI SDK: Received message without type",t)}else console.warn("Voice AI SDK: Received empty message")}catch(e){console.error("Voice AI SDK: Error parsing message",e)}}_onDataChannelClose(){console.log("Voice AI SDK: Data channel closed"),this.isListening=!1}_onDataChannelError(e){console.error("Voice AI SDK: Data channel error",e)}_onIceCandidate(e){e.candidate&&console.log("Voice AI SDK: New ICE candidate",e.candidate)}_onConnectionStateChange(){if(this.peerConnection)switch(console.log("Voice AI SDK: Connection state changed to",this.peerConnection.connectionState),this.peerConnection.connectionState){case"connected":console.log("Voice AI SDK: WebRTC connection established"),this._updateUI("idle");break;case"disconnected":case"failed":console.log("Voice AI SDK: WebRTC connection lost"),this._updateUI("error");break;case"closed":console.log("Voice AI SDK: WebRTC connection closed"),this._updateUI("inactive")}}_cleanupWebRTC(){this._stopVolumeDetection(),this.dataChannel&&(this.dataChannel.close(),this.dataChannel=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>e.stop()),this.mediaStream=null),this.audioContext&&(this.audioContext.close().catch(console.error),this.audioContext=null,this.analyser=null),this.isListening=!1,this.currentVolume=0,this._updateUI("idle")}async startSession(){if(!this.isActive)try{await this._initWebRTC(),await this._configureSession(),this.isActive=!0,this.isListening=!0,"function"==typeof this.config.onStart&&this.config.onStart()}catch(e){console.error("Voice AI SDK: Failed to start session",e),this._cleanupWebRTC(),"function"==typeof this.config.onError&&this.config.onError(e)}}stopSession(){console.log("Voice AI SDK: Stopping session"),this.volumeInterval&&(clearInterval(this.volumeInterval),this.volumeInterval=null),this.volumeTimeout&&(clearTimeout(this.volumeTimeout),this.volumeTimeout=null),this.audioContext&&(this.audioContext.close().catch(console.error),this.audioContext=null,this.analyser=null),this._cleanupWebRTC(),this.isActive=!1,"function"==typeof this.config.onEnd&&this.config.onEnd()}toggleSession(){this.isActive?this.stopSession():this.startSession()}async _initWebRTC(){try{console.log("Voice AI SDK: Initializing WebRTC"),this.peerConnection=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),this.peerConnection.onicecandidate=this._onIceCandidate.bind(this),this.peerConnection.onconnectionstatechange=this._onConnectionStateChange.bind(this),this.stream=await navigator.mediaDevices.getUserMedia({audio:!0}),this._setupAudioVisualization(this.stream),this.stream.getAudioTracks().forEach(e=>{this.peerConnection.addTrack(e,this.stream)}),this.audioElement=document.createElement("audio"),this.audioElement.autoplay=!0,this.peerConnection.ontrack=e=>{console.log("Voice AI SDK: Received audio track"),this.audioElement.srcObject=e.streams[0]},this.dataChannel=this.peerConnection.createDataChannel("response"),this.dataChannel.onopen=this._onDataChannelOpen.bind(this),this.dataChannel.onmessage=this._onDataChannelMessage.bind(this),this.dataChannel.onclose=this._onDataChannelClose.bind(this),this.dataChannel.onerror=this._onDataChannelError.bind(this);var e=await this.peerConnection.createOffer();return await this.peerConnection.setLocalDescription(e),console.log("Voice AI SDK: Created offer"),!0}catch(e){return console.error("Voice AI SDK: Error initializing WebRTC",e),this._updateUI("error"),!1}}_setupAudioVisualization(e){try{var t=new(a.AudioContext||a.webkitAudioContext),i=t.createMediaStreamSource(e);let o=t.createAnalyser();o.fftSize=256,i.connect(o);var n=o.frequencyBinCount;let s=new Uint8Array(n);this.volumeInterval=setInterval(()=>{var e=(()=>{o.getByteTimeDomainData(s);let t=0;for(let e=0;e<s.length;e++){var i=(s[e]-128)/128;t+=i*i}return Math.sqrt(t/s.length)})();.02<e?this._updateUI("volume",e):"volume"!==this.uiMode||this.volumeTimeout||(this.volumeTimeout=setTimeout(()=>{this._updateUI("idle"),this.volumeTimeout=null},500))},100),this.audioContext=t,this.analyser=o}catch(e){console.error("Voice AI SDK: Error setting up audio visualization",e)}}_startVolumeDetection(){if(this.analyser){let i=this.analyser.frequencyBinCount,o=new Uint8Array(i);this.volumeInterval=setInterval(()=>{if(this.analyser){this.analyser.getByteFrequencyData(o);let t=0;for(let e=0;e<i;e++)t+=o[e];this.currentVolume=t/i/255,this.isListening&&.02<this.currentVolume?this._updateUI("volume"):"volume"===this.mode&&this._updateUI("idle")}},100)}}_stopVolumeDetection(){this.volumeInterval&&(clearInterval(this.volumeInterval),this.volumeInterval=null)}}a.VoiceAI={init:e=>new t(e)}})(window);