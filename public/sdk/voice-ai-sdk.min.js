/**
 * Voice AI SDK (Minified)
 * @version 1.0.0
 */
!function(e){"use strict";const t={position:"bottom-right",theme:"light",language:"en",serverUrl:e.location.origin,customStyles:{}};class s{constructor(e){this.config={...t,...e},this.clientId=this.config.clientId,this.sessionId=null,this.isActive=!1,this.isListening=!1,this.audioContext=null,this.mediaStream=null,this.peerConnection=null,this.dataChannel=null,this.analyser=null,this.volumeInterval=null,this.currentVolume=0,this.messages=[],this.ui=null,this.mode="idle",this.clientId?this._init():console.error("Voice AI SDK: Client ID is required")}async _init(){try{this._loadSession(),await this._validateClient(),await this._initSession(),this._createUI(),this._registerEventListeners(),"function"==typeof this.config.onReady&&this.config.onReady()}catch(e){console.error("Voice AI SDK: Initialization failed",e),"function"==typeof this.config.onError&&this.config.onError(e)}}_loadSession(){try{const e=localStorage.getItem("voice_ai_session");if(e){const t=JSON.parse(e);t.clientId===this.clientId&&(this.sessionId=t.sessionId)}}catch(e){console.error("Voice AI SDK: Failed to load session",e)}}_saveSession(){try{localStorage.setItem("voice_ai_session",JSON.stringify({clientId:this.clientId,sessionId:this.sessionId}))}catch(e){console.error("Voice AI SDK: Failed to save session",e)}}async _validateClient(){try{const e=await fetch(`${this.config.serverUrl}/api/v1/auth/validate`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:this.clientId})}),t=await e.json();if(!e.ok||!t.valid)throw new Error(t.error||"Client validation failed")}catch(e){throw console.error("Voice AI SDK: Client validation failed",e),e}}async _initSession(){try{if(this.sessionId){const e=await fetch(`${this.config.serverUrl}/api/v1/sessions?sessionId=${this.sessionId}`,{method:"GET"});if(!e.ok)return this._initSession()}else{const e=await fetch(`${this.config.serverUrl}/api/v1/sessions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:this.clientId})}),t=await e.json();if(!e.ok)throw new Error(t.error||"Failed to create session");this.sessionId=t.sessionId,this._saveSession()}}catch(e){throw console.error("Voice AI SDK: Session initialization failed",e),e}}_createUI(){const e=document.createElement("div");e.className="voice-ai-container",e.style.position="fixed";switch(this.config.position){case"bottom-right":e.style.bottom="20px",e.style.right="20px";break;case"bottom-left":e.style.bottom="20px",e.style.left="20px";break;case"top-right":e.style.top="20px",e.style.right="20px";break;case"top-left":e.style.top="20px",e.style.left="20px";break;default:e.style.bottom="20px",e.style.right="20px"}const t=document.createElement("div");t.className="voice-ai-button",t.style.width="64px",t.style.height="64px",t.style.borderRadius="50%",t.style.backgroundColor=this.config.customStyles.buttonColor||"#3a86ff",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.cursor="pointer",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)",t.style.transition="all 0.3s ease";const s=document.createElement("div");s.className="voice-ai-animation",s.style.width="100%",s.style.height="100%",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center";const i=document.createElement("div");i.className="voice-ai-idle-animation",i.style.width="32px",i.style.height="32px",i.style.borderRadius="50%",i.style.backgroundColor="#ffffff",i.style.opacity="0.8",i.style.animation="voice-ai-pulse 2s infinite",s.appendChild(i),t.appendChild(s),e.appendChild(t);const n=document.createElement("style");n.textContent="\n        @keyframes voice-ai-pulse {\n          0% { transform: scale(0.8); opacity: 0.5; }\n          50% { transform: scale(1); opacity: 1; }\n          100% { transform: scale(0.8); opacity: 0.5; }\n        }\n        \n        @keyframes voice-ai-thinking {\n          0% { transform: scale(1) rotate(0deg); }\n          50% { transform: scale(1.2) rotate(180deg); }\n          100% { transform: scale(1) rotate(360deg); }\n        }\n        \n        @keyframes voice-ai-volume {\n          0% { height: 10px; }\n          50% { height: 30px; }\n          100% { height: 10px; }\n        }\n      ",document.head.appendChild(n),document.body.appendChild(e),this.ui={container:e,button:t,animationContainer:s,idleAnimation:i},t.addEventListener("click",()=>{this.toggleSession()})}_registerEventListeners(){e.addEventListener("beforeunload",()=>{this.isActive&&this.stopSession()})}_updateUI(e){if(!this.ui)return;this.mode=e;for(;this.ui.animationContainer.firstChild;)this.ui.animationContainer.removeChild(this.ui.animationContainer.firstChild);switch(e){case"idle":const e=document.createElement("div");e.className="voice-ai-idle-animation",e.style.width="32px",e.style.height="32px",e.style.borderRadius="50%",e.style.backgroundColor="#ffffff",e.style.opacity="0.8",e.style.animation="voice-ai-pulse 2s infinite",this.ui.animationContainer.appendChild(e),this.ui.idleAnimation=e;break;case"thinking":const t=document.createElement("div");t.className="voice-ai-thinking-animation",t.style.width="32px",t.style.height="32px",t.style.borderRadius="50%",t.style.border="3px solid #ffffff",t.style.borderTopColor="transparent",t.style.animation="voice-ai-thinking 1s infinite linear",this.ui.animationContainer.appendChild(t);break;case"responding":const s=document.createElement("div");s.className="voice-ai-responding-animation",s.style.width="32px",s.style.height="32px",s.style.backgroundImage='url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>\')',s.style.backgroundSize="contain",s.style.backgroundRepeat="no-repeat",s.style.animation="voice-ai-pulse 2s infinite",this.ui.animationContainer.appendChild(s);break;case"volume":const i=document.createElement("div");i.className="voice-ai-volume-container",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",i.style.gap="3px",i.style.height="32px";for(let e=0;e<4;e++){const t=document.createElement("div");t.className="voice-ai-volume-bar",t.style.width="4px",t.style.height=`${10+20*Math.random()}px`,t.style.backgroundColor="#ffffff",t.style.borderRadius="2px",t.style.animation=`voice-ai-volume ${.5+.5*Math.random()}s infinite`,t.style.animationDelay=`${.1*e}s`,i.appendChild(t)}this.ui.animationContainer.appendChild(i)}}async _getEphemeralToken(){try{const e=await fetch(`${this.config.serverUrl}/api/v1/voice/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:this.clientId,sessionId:this.sessionId})}),t=await e.json();if(!e.ok)throw new Error(t.error||"Failed to get ephemeral token");return t.client_secret.value}catch(e){throw console.error("Voice AI SDK: Failed to get ephemeral token",e),e}}async _initWebRTC(){try{this.audioContext=new(e.AudioContext||e.webkitAudioContext),this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=1024;const t=this.audioContext.createMediaStreamSource(this.mediaStream);t.connect(this.analyser),this.peerConnection=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),this.mediaStream.getAudioTracks().forEach(e=>{this.peerConnection.addTrack(e,this.mediaStream)}),this.dataChannel=this.peerConnection.createDataChannel("audio"),this.dataChannel.onopen=this._onDataChannelOpen.bind(this),this.dataChannel.onmessage=this._onDataChannelMessage.bind(this),this.dataChannel.onclose=this._onDataChannelClose.bind(this),this.dataChannel.onerror=this._onDataChannelError.bind(this),this.peerConnection.onicecandidate=this._onIceCandidate.bind(this),this.peerConnection.onconnectionstatechange=this._onConnectionStateChange.bind(this);const s=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(s),this._startVolumeDetection(),this._updateUI("idle")}catch(e){throw console.error("Voice AI SDK: WebRTC initialization failed",e),e}}_startVolumeDetection(){if(this.analyser){const e=this.analyser.frequencyBinCount,t=new Uint8Array(e);this.volumeInterval=setInterval(()=>{if(!this.analyser)return;this.analyser.getByteFrequencyData(t);let e=0;for(let s=0;s<t.length;s++)e+=t[s];this.currentVolume=e/t.length/255,this.isListening&&this.currentVolume>.02?this._updateUI("volume"):"volume"===this.mode&&this._updateUI("idle")},100)}}_stopVolumeDetection(){this.volumeInterval&&(clearInterval(this.volumeInterval),this.volumeInterval=null)}_onDataChannelOpen(){console.log("Voice AI SDK: Data channel open"),this._configureSession()}async _configureSession(){if(this.dataChannel&&"open"===this.dataChannel.readyState)try{const e=await this._getEphemeralToken(),t={type:"session.update",session:{modalities:["text","audio"],tools:[],turn_detection:{type:"server_vad",threshold:.5,prefix_padding_ms:300,silence_duration_ms:200,create_response:!0},instructions:this.config.instructions||"You are a helpful voice assistant."}};this.dataChannel.send(JSON.stringify(t));const s={type:"auth",client_secret:e};this.dataChannel.send(JSON.stringify(s));const i={type:"voice.update",voice:{voice_id:this.config.voice||"alloy"}};this.dataChannel.send(JSON.stringify(i)),this.isListening=!0}catch(e){console.error("Voice AI SDK: Session configuration failed",e),this.stopSession()}}_onDataChannelMessage(e){try{const t=JSON.parse(e.data);switch(this.messages.push(t),t.type){case"input_audio_buffer.speech_started":this._updateUI("thinking");break;case"conversation.item.created":this._updateUI("responding");break;case"conversation.item.completed":this._updateUI("idle")}}catch(e){console.error("Voice AI SDK: Failed to parse message",e)}}_onDataChannelClose(){console.log("Voice AI SDK: Data channel closed"),this.isListening=!1}_onDataChannelError(e){console.error("Voice AI SDK: Data channel error",e)}_onIceCandidate(e){e.candidate&&console.log("Voice AI SDK: New ICE candidate",e.candidate)}_onConnectionStateChange(){console.log("Voice AI SDK: Connection state changed",this.peerConnection.connectionState),("disconnected"===this.peerConnection.connectionState||"failed"===this.peerConnection.connectionState||"closed"===this.peerConnection.connectionState)&&this.stopSession()}_cleanupWebRTC(){this._stopVolumeDetection(),this.dataChannel&&(this.dataChannel.close(),this.dataChannel=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.mediaStream&&(this.mediaStream.getTracks().forEach(e=>e.stop()),this.mediaStream=null),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.analyser=null,this.isListening=!1,this.currentVolume=0,this._updateUI("idle")}async startSession(){if(!this.isActive)try{await this._initWebRTC(),this.isActive=!0,"function"==typeof this.config.onStart&&this.config.onStart()}catch(e){console.error("Voice AI SDK: Failed to start session",e),this._cleanupWebRTC(),"function"==typeof this.config.onError&&this.config.onError(e)}}stopSession(){this.isActive&&(this._cleanupWebRTC(),this.isActive=!1,"function"==typeof this.config.onEnd&&this.config.onEnd())}toggleSession(){this.isActive?this.stopSession():this.startSession()}}e.VoiceAI={init:e=>new s(e)}}(window); 